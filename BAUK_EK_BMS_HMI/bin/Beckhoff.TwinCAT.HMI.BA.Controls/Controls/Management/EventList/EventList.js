var TcHmi,__awaiter=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(s,i){function a(e){try{r(o.next(e))}catch(e){i(e)}}function l(e){try{r(o.throw(e))}catch(e){i(e)}}function r(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,l)}r((o=o.apply(e,t||[])).next())}))};!function(e){!function(t){!function(n){!function(o){class s extends n.System.BaseControl{constructor(n,o,i){super(n,o,i),this.__loadBaChildren=!0,this.__loadTexts=!0,this.__columnSorting=s.DefaultColumnSorting,this.__header=$("<div>").addClass("header"),this.__eventToggles=new Map,this.__historyToggle=new t.Components.ToggleButton(this.__id+"-history-toggle",this),this.__confirmButton=new t.Components.Button(this.__id+"-confirm-button",this),this.__confirmAllButton=new t.Components.Button(this.__id+"-confirm-all-button",this),this.__siteEventsSymbol=new e.Symbol(t.Helper.String.toSymbolExpression(t.Server.EventsSymbols.List)),this.__siteEventHistorySymbol=new e.Symbol(t.Helper.String.toSymbolExpression(t.Server.EventHistorySymbols.List)),this.__legendIconHandler=new t.Components.LegendIconHandler,this.__subscriptionIds={},this.__selectedItemChangedHandler=()=>{var e;let t=null===(e=this.__dataGrid)||void 0===e?void 0:e.getSelectedRowValue();s.__detectCanAcknowledge(t)?this.__confirmButton.setIsEnabled(!0):this.__confirmButton.setIsEnabled(!1)},this.__rowClassesProviderFunc=(e,n)=>{0==n.a?$(e).hide():($(e).show(),n.e&&null!=n.e.s&&null!=n.e.t&&n.e.t<=t.BA.EventCondition.eTypeOther&&(n.e.s!==t.BA.EventIconState.eGone&&n.e.s!==t.BA.EventIconState.ePresent||n.h||$(e).addClass("shows-event-pulse")))}}__previnit(){if(super.__previnit(),this.baObjectHandler=new t.BaObjectHandler(this),this.__dataGrid=e.ControlFactory.createEx("TcHmi.BuildingAutomation.Controls.Common.DataGrid",this.__id+"-data-grid",null,this),!this.__dataGrid)return;this.__element.append(this.__header,this.__dataGrid.getElement()),this.__element.addClass("TcHmi_Controls_Beckhoff_TcHmiEventGrid-template"),this.__updateColumns(),this.__dataGrid.setSorting([{order:"Descending",name:"ts"}]),e.System.Services.themeManager.unwatchAttributeDefaults(this.__dataGrid,"RowClassesProvider"),this.__dataGrid.setRowClassesProvider(this.__rowClassesProviderFunc);let n=$("<div>").addClass("event-toggles-container");this.__header.append(n);let o,s=[{id:"alarm-toggle",type:t.BA.EventCondition.eTypeAlarm,icon:"/"+t.Icons.Events.Event.Alarm.path,iconColor:t.Color.RGBAColor.Red},{id:"disturbance-toggle",type:t.BA.EventCondition.eTypeDisturb,icon:"/"+t.Icons.Events.Event.Disturbance.path,iconColor:new t.Color.RGBAColor({r:255,g:180,b:0,a:1})},{id:"maintenance-toggle",type:t.BA.EventCondition.eTypeMaintenance,icon:"/"+t.Icons.Events.Event.Maintenance.path},{id:"notification-toggle",type:t.BA.EventCondition.eTypeNotification,icon:"/"+t.Icons.Events.Event.Notification.path},{id:"other-toggle",type:t.BA.EventCondition.eTypeOther,icon:"/"+t.Icons.Events.Event.Other.path}];for(let e=0;e<s.length;e++)o=new t.Components.ToggleButton(this.__id+"-"+s[e].id,this),o.switchColorOnDown=!1,o.setToggleState(!0),o.textHandler.setText("0").setHorizontalAlignment("Right").setVerticalAlignment("Center"),o.backgroundStyler.setImage(s[e].icon,!0).setImageColor(s[e].iconColor).setImageHeight(20).setImageWidth(20).setImageHorizontalAlignment("Left"),n.append(o.getElement()),this.__eventToggles.set(s[e].type,o);this.__legendIconHandler.icon=[t.Icons.Events.Event.Alarm,t.Icons.Events.Event.Disturbance,t.Icons.Events.Event.Maintenance,t.Icons.Events.Event.Notification,t.Icons.Events.Event.Other],this.__historyToggle.backgroundStyler.setImage(t.Icons.Standard.List.path,!0).setImageHeight(80,"%").setImageWidth(80,"%"),this.__historyToggle.getElement().addClass("history-toggle"),this.__header.append(this.__historyToggle.getElement()),this.__confirmButton.backgroundStyler.setImage(t.Icons.Standard.Confirm.path,!0).setImageHeight(80,"%").setImageWidth(80,"%"),this.__confirmButton.setIsEnabled(!1).getElement().addClass("confirm-button"),this.__header.append(this.__confirmButton.getElement()),this.__confirmAllButton.backgroundStyler.setImage(t.Icons.Standard.ConfirmAll.path,!0).setImageHeight(80,"%").setImageWidth(80,"%"),this.__confirmAllButton.setIsEnabled(!1).getElement().addClass("confirm-all-button"),this.__header.append(this.__confirmAllButton.getElement())}__init(){super.__init()}__attach(){super.__attach(),null!=this.__dataGrid&&(this.__destroyersToCallOnDetach.push(e.EventProvider.register(this.__dataGrid.getId()+".onDataChanged",()=>this.eventHandler.raise(s.EventListEvents.onEventsChanged))),this.__destroyersToCallOnDetach.push(e.EventProvider.register(this.__dataGrid.getId()+".onSelectedItemChanged",this.__selectedItemChangedHandler)));for(let[e,n]of this.__eventToggles)this.__destroyersToCallOnDetach.push(n.eventHandler.register(t.Components.ToggleButton.ToggleButtonEvents.onToggleStateChanged,()=>{var e;this.__processEventToggles(),null===(e=this.__dataGrid)||void 0===e||e.setSelectedRowIndex(null)}));this.__destroyersToCallOnDetach.push(this.__historyToggle.eventHandler.register(t.Components.ToggleButton.ToggleButtonEvents.onToggleStateChanged,()=>{var e;this.__watchEvents(),this.__processEventToggles(),null===(e=this.__dataGrid)||void 0===e||e.setSelectedRowIndex(null)})),this.__destroyersToCallOnDetach.push(this.__confirmButton.eventHandler.register(t.Components.Button.ButtonEvents.onPressed,()=>{var e,n,o;let i=null===(e=this.__dataGrid)||void 0===e?void 0:e.getSelectedRowValue();if(i&&(this.eventHandler.raise(s.EventListEvents.onEventAcknowledged,i),(this.__isGlobalEventList||this.baObjectHandler.baObject)&&t.Server.isIBaEventServerResult(i))){let e=null===(n=t.BA.BaDevices)||void 0===n?void 0:n.get(i.d);if(e){let t=e.findBaObject(i.id);null==t||t.acknowledge()}}null===(o=this.__dataGrid)||void 0===o||o.setSelectedRowIndex(null),this.__selectedItemChangedHandler()})),this.__destroyersToCallOnDetach.push(this.__confirmAllButton.eventHandler.register(t.Components.Button.ButtonEvents.onPressed,()=>__awaiter(this,void 0,void 0,(function*(){var n,o;let i=t.Locale.Localization.getText(t.Locale.LangKey.ConfirmAcknowledgeAllEvents);if((yield t.Components.DialogWindow.confirm(i))&&(this.eventHandler.raise(s.EventListEvents.onAllEventsAcknowledged),this.__isGlobalEventList||this.baObjectHandler.baObject)){const o={commands:[],requestType:"ReadWrite"},s=null===(n=this.__dataGrid.getDataSymbol())||void 0===n?void 0:n.getExpression();if(null==s)throw new Error("No data symbol was set for the data grid!");if(s.getType()!=e.SymbolType.Server)throw new Error("Symbol expression is not from a server symbol!");o.commands.push({commandOptions:["SendErrorMessage"],symbol:s.getName(),filter:this.__currentConfirmAllFilter});let i=this.busyHandler.setBusy("Get all acknowledgeable events.",{optionalOutput:{request:o}});e.Server.requestEx(o,{parallel:!0},e=>{var n;t.Server.checkServerResult(t.Logger.Severity.warn,e)?(i(),null!=(null===(n=e.response)||void 0===n?void 0:n.commands)&&e.response.commands.forEach(e=>{var n;let o;for(let s=0;s<e.readValue.length;s++)if(o=e.readValue[s],t.Server.isIBaEventServerResult(o)){let e=null===(n=t.BA.BaDevices)||void 0===n?void 0:n.get(o.d);if(e){let t=e.findBaObject(o.id);null==t||t.acknowledge()}}})):this.logger.log(t.Logger.Severity.warn,"Getting all acknowledgeable events failed!",{reason:e,request:o})})}null===(o=this.__dataGrid)||void 0===o||o.setSelectedRowIndex(null),this.__selectedItemChangedHandler()})))),this.__destroyersToCallOnDetach.push(e.EventProvider.register("onLocaleChanged",()=>{this.__updateColumns()})),this.__destroyersToCallOnDetach.push(e.EventProvider.register(t.GlobalEvents.onCustomBaNewPulse,()=>{var e;let t,n=null===(e=this.__dataGrid)||void 0===e?void 0:e.getCurrentRows();if(!n)return;let o=e=>{e.data.removeClass("pulse"),e.data.off("animationend",o)};for(let e=0;e<n.length;e++)t=$(n[e]),t.hasClass("shows-event-pulse")&&(t.hasClass("pulse")&&t.removeClass("pulse"),t.addClass("pulse"),t.on("animationend",t,o))})),this.__legendIconHandler.show()}__detach(){super.__detach(),this.__legendIconHandler.hide()}destroy(){if(!this.__keepAlive){this.__stopSubscriptions(),this.__siteEventsSymbol&&this.__siteEventsSymbol.destroy(),this.__siteEventHistorySymbol&&this.__siteEventHistorySymbol.destroy(),this.__historyToggle.destroy(),this.__confirmButton.destroy(),this.__confirmAllButton.destroy();for(let e of this.__eventToggles.values())e.destroy();super.destroy()}}__watchEvents(){var n,o,s,i,a;this.__stopSubscriptions();const l=this.__historyToggle.getToggleState();1==l?this.__isGlobalEventList?null===(n=this.__dataGrid)||void 0===n||n.setDataSymbol(this.__siteEventHistorySymbol):(this.baObjectHandler.baObject instanceof t.BA.BaView||this.baObjectHandler.baObject instanceof t.BA.BaObject)&&null!=this.baObjectHandler.baObjectSymbolExpression&&(null===(o=this.__dataGrid)||void 0===o||o.setDataSymbol(new e.Symbol(this.baObjectHandler.baObjectSymbolExpression.getSubSymbolExpression("::EventHistory").toString()))):this.__isGlobalEventList?null===(s=this.__dataGrid)||void 0===s||s.setDataSymbol(this.__siteEventsSymbol):null!=this.baObjectHandler.baObjectSymbolExpression&&(null===(i=this.__dataGrid)||void 0===i||i.setDataSymbol(new e.Symbol(this.baObjectHandler.baObjectSymbolExpression.getSubSymbolExpression("::Events").toString())));let r,d=this.busyHandler.setBusy("Loading event count per type.");this.__isGlobalEventList||null==this.baObjectHandler.baObject||(r=this.baObjectHandler.baObject),this.__subscriptionIds.eventCountPerType=t.Server.watchEventCountPerType(l,r,e=>{null!=d&&(d(),d=void 0),this.__eventToggles.forEach((t,n)=>{let o=e.get(n);null==o&&(o=0),null==t||t.textHandler.setText(o.toString())})});let c=this.busyHandler.setBusy("Loading acknowledgeable event count per type.");this.__subscriptionIds.acknowledgeableEventCountPerType=t.Server.watchAcknowledgeableEventCountPerType(r,e=>{null!=c&&(c(),c=void 0),this.__acknowledgeableEventCountPerType=e,this.__updateConfirmButton()}),this.__processEventToggles(),null===(a=this.__dataGrid)||void 0===a||a.setSelectedRowIndex(null)}__stopSubscriptions(){var t;null===(t=this.__dataGrid)||void 0===t||t.setDataSymbol(null);for(let t in this.__subscriptionIds)e.Server.unsubscribeEx(this.__subscriptionIds[t],{parallel:!0})}__getColumnDefinition(e){switch(e){case s.Columns.baIdentifier:return{name:"id",label:"",type:n.Common.DataGrid.ControlType.Button,sortable:!0,width:30,widthUnit:"px",formatEx:(e,n)=>{null!=e&&n.backgroundStyler.setImage(t.Icons.ObjectType.Path+"/"+t.BA.ObjectType[e.ObjectType]+".svg",!0)},callback:(e,n,o)=>{var s;let i=null===(s=t.BA.BaDevices)||void 0===s?void 0:s.get(n.rowData.d);if(i){let e=i.findBaObject(n.columnData);if(null!=e){let t=o.busyHandler.setBusy("Loading BaObject attributes.");e.loadAttributes().then(()=>{t(),null==e||e.openParameterDialog()})}else this.logger.log(t.Logger.Severity.warn,`BaObject could not be found in device '${i.Description}'`,n)}else this.logger.log(t.Logger.Severity.warn,"Device of BaObject could not be obtained. Opening of parameter dialog is not possible.",n)}};case s.Columns.event:return{name:"e",label:"",type:n.Common.DataGrid.ControlType.EventIcon,sortable:!1,width:30,widthUnit:"px"};case s.Columns.timestamp:return{name:"ts",label:t.Locale.Localization.getSymbolExpression(t.Locale.LangKey.TimeStamp),type:n.Common.DataGrid.ControlType.DateTimeField,sortable:!0,settings:{readOnly:!0},minWidth:165,width:165,widthUnit:"px"};case s.Columns.device:return{name:"d",label:t.Locale.Localization.getSymbolExpression(t.Locale.LangKey.Device),type:n.Common.DataGrid.ControlType.Textblock,sortable:!0,resize:!0,minWidth:90,width:90,widthUnit:"px",horizontalAlignment:"Left"};case s.Columns.objectName:return{name:"o",label:t.Locale.Localization.getSymbolExpression(t.Locale.LangKey.ObjectName),type:n.Common.DataGrid.ControlType.Textblock,sortable:!0,resize:!0,minWidth:150,width:300,widthUnit:"px",horizontalAlignment:"Left"};case s.Columns.instancePath:return{name:"ip",label:t.Locale.Localization.getSymbolExpression(t.Locale.LangKey.InstancePath),type:n.Common.DataGrid.ControlType.Textblock,sortable:!0,resize:!0,minWidth:150,width:300,widthUnit:"px",horizontalAlignment:"Left"};case s.Columns.description:return{name:"desc",label:t.Locale.Localization.getSymbolExpression(t.Locale.LangKey.Description),type:n.Common.DataGrid.ControlType.Textblock,minWidth:350,sortable:!0,resize:!0,width:500,widthUnit:"px",horizontalAlignment:"Left"};case s.Columns.eventClass:return{name:"ecID",label:t.Locale.Localization.getSymbolExpression(t.Locale.LangKey.EventClassID),type:n.Common.DataGrid.ControlType.Textblock,sortable:!0,width:90,widthUnit:"px",horizontalAlignment:"Left"};case s.Columns.eventClassInstanceDescription:return{name:"ecInstDesc",label:t.Locale.Localization.getSymbolExpression(t.Locale.LangKey.EventClass),type:n.Common.DataGrid.ControlType.Textblock,minWidth:100,sortable:!0,width:200,widthUnit:"px",horizontalAlignment:"Left"};case s.Columns.eventClassDescription:return{name:"ecDesc",label:t.Locale.Localization.getSymbolExpression(t.Locale.LangKey.EventClass),type:n.Common.DataGrid.ControlType.Textblock,minWidth:100,sortable:!0,resize:!0,width:250,widthUnit:"px",horizontalAlignment:"Left"};default:throw new Error("Unknown column was passed!")}}__updateColumns(){var e;let t=[];for(let e=0;e<this.__columnSorting.length;e++)t.push(this.__getColumnDefinition(this.__columnSorting[e]));null===(e=this.__dataGrid)||void 0===e||e.setSrcColumn(t)}__processEventToggles(){var e;this.__updateConfirmButton();let t=[];for(const[e,n]of this.__eventToggles)1!=n.getToggleState()&&(0!==t.length&&t.push({logic:"AND"}),t.push({path:"e::t",comparator:"!=",value:e}));null===(e=this.__dataGrid)||void 0===e||e.setFilter(t),t.length>0?(this.__currentConfirmAllFilter=t.slice(0),this.__currentConfirmAllFilter.push({logic:"AND"})):this.__currentConfirmAllFilter=[],this.__currentConfirmAllFilter=this.__currentConfirmAllFilter.concat(s.acknowledgeableEventsFilter)}__updateConfirmButton(){var e;this.__confirmAllButton.setIsEnabled(!1);for(let[t,n]of this.__eventToggles){let o=null===(e=this.__acknowledgeableEventCountPerType)||void 0===e?void 0:e.get(t);if(n.getToggleState()&&null!=o&&o>0){this.__confirmAllButton.setIsEnabled(!0);break}}}static __detectCanAcknowledge(e){if(e)switch(e.e.s){case t.BA.EventIconState.eIndicatd:case t.BA.EventIconState.eGone:case t.BA.EventIconState.eGoneAcked:case t.BA.EventIconState.ePresent:return!e.h}return!1}setBaObject(e){return this.baObjectHandler.setBaObject(e),this}getBaObject(){return this.baObjectHandler.baObject}setIsGlobalEventList(t){let n=e.ValueConverter.toBoolean(t);return null==n&&(n=this.getAttributeDefaultValueInternal("IsGlobalEventList")),n===this.__isGlobalEventList||(null==n&&(n=!1),this.__isGlobalEventList=n,this.__processIsGlobalEventList(),e.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"IsGlobalEventList"})),this}__processIsGlobalEventList(){return __awaiter(this,void 0,void 0,(function*(){if(this.baObjectHandler.baObject&&(yield t.Components.DialogWindow.alert("It is not possible to use global site events after a BaObject / BaView was set. Reload page to use global events from the SiteApi!")),this.__isGlobalEventList){if(null==t.BA.BaDevices)e.EventProvider.register(t.Server.Events.onBaDeviesLoaded,e=>{e.destroy(),this.__processIsGlobalEventList()});else if(null!=t.BA.BaDevices&&t.BA.BaDevices.size>0){let n=[];t.BA.BaDevices.forEach(e=>n.push(e.Description));for(let o of t.BA.BaDevices.values()){let t=this.busyHandler.setBusy("Loading texts and children of PorjectStructure of device "+o.Description),s=()=>{o.ProjectStructure.loadTexts(!0).then(()=>{n.splice(n.indexOf(o.Description),1),t(),0==n.length&&this.__watchEvents()})};if(!o.projectStructureLoaded){let t=e.EventProvider.register(o.eventNames.onProjectStructureLoaded,()=>{t(),s()});return}s()}}}else this.__stopSubscriptions()}))}getIsGlobalEventList(){return this.__isGlobalEventList}setColumnSorting(n){let o=e.ValueConverter.toObject(n);if(null==o&&(o=this.getAttributeDefaultValueInternal("ColumnSorting")),null!=o)for(let e=0;e<(null==o?void 0:o.length);e++)if("string"==typeof o[e]){let n=Number(o[e]);if(isNaN(n)&&(n=s.Columns[o[e]],isNaN(n))){this.logger.log(t.Logger.Severity.warn,"Invalid ColumnSorting was set",o),o=null;break}o[e]=n}return o===this.__columnSorting||(null==o&&(o=s.DefaultColumnSorting),this.__columnSorting=o,this.__processColumnSorting(),e.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"ColumnSorting"})),this}__processColumnSorting(){return __awaiter(this,void 0,void 0,(function*(){this.__updateColumns()}))}getColumnSorting(){return this.__columnSorting}processBaObject(){var e;if(this.baObjectHandler.baObject){if(this.__isGlobalEventList)return alert("It is not possible to set BaObject / BaView events after the EventList uses the global events from the site. Reload page to use BaObject / BaView events!"),void console.warn("It is not possible to set BaObject / BaView events after the EventList uses the global events from the site. Reload page to use BaObject / BaView events!");null===(e=this.__dataGrid)||void 0===e||e.setSrcData(null),this.__watchEvents()}}}o.EventList=s,function(e){let n,o;!function(e){e.onEventsChanged="onEventsChanged",e.onEventAcknowledged="onEventAcknowledged",e.onAllEventsAcknowledged="onAllEventsAcknowledged"}(n=e.EventListEvents||(e.EventListEvents={})),e.acknowledgeableEventsFilter=[{path:"h",comparator:"==",value:!1},{logic:"AND"},[{path:"e::s",comparator:"==",value:t.BA.EventIconState.eIndicatd},{logic:"OR"},{path:"e::s",comparator:"==",value:t.BA.EventIconState.eGone},{logic:"OR"},{path:"e::s",comparator:"==",value:t.BA.EventIconState.eGoneAcked},{logic:"OR"},{path:"e::s",comparator:"==",value:t.BA.EventIconState.ePresent}]],function(e){e[e.baIdentifier=0]="baIdentifier",e[e.event=1]="event",e[e.timestamp=2]="timestamp",e[e.device=3]="device",e[e.objectName=4]="objectName",e[e.instancePath=5]="instancePath",e[e.description=6]="description",e[e.eventClass=7]="eventClass",e[e.eventClassInstanceDescription=8]="eventClassInstanceDescription",e[e.eventClassDescription=9]="eventClassDescription"}(o=e.Columns||(e.Columns={})),e.DefaultColumnSorting=[o.baIdentifier,o.event,o.timestamp,o.device,o.objectName,o.instancePath,o.description,o.eventClass,o.eventClassInstanceDescription]}(s=o.EventList||(o.EventList={}))}(n.Management||(n.Management={}))}(t.Controls||(t.Controls={}))}(e.BuildingAutomation||(e.BuildingAutomation={}))}(TcHmi||(TcHmi={})),TcHmi.Controls.registerEx("EventList","TcHmi.BuildingAutomation.Controls.Management",TcHmi.BuildingAutomation.Controls.Management.EventList);