var TcHmi,__awaiter=this&&this.__awaiter||function(e,t,n,a){return new(n||(n=Promise))((function(s,i){function r(e){try{l(a.next(e))}catch(e){i(e)}}function o(e){try{l(a.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,o)}l((a=a.apply(e,t||[])).next())}))};!function(e){!function(t){!function(n){!function(a){class s extends n.System.BaseControl{constructor(e,n,a){super(e,n,a),this.__contentWindow=new t.Components.ContentWindow(this.__id+"-content-window",this),this.__tabWindow=new t.Components.TabWindow(this.__id+"-tab-window",this),this.__contextMenu=this.__contentWindow.addMenu(),this.__orientation=null,this.__snapPeriode=null,this.__showHeader=null,this.__saveButtonPressedHandler=()=>__awaiter(this,void 0,void 0,(function*(){var e,n,a;null===(e=this.__contextMenu)||void 0===e||e.close(),(yield t.Components.DialogWindow.confirm(t.Locale.Localization.getText(t.Locale.LangKey.ConfirmSaveChangesToPlc)))&&(yield this.writeScheduleToPlc())&&(null===(n=this.__saveButton)||void 0===n||n.setIsEnabled(!1),null===(a=this.__resetButton)||void 0===a||a.setIsEnabled(!1),this.eventHandler.raise(s.ScheduleEvents.onSaved))})),this.__resetButtonPressedHandler=()=>__awaiter(this,void 0,void 0,(function*(){var e,n,a;let s=t.Locale.Localization.getText(t.Locale.LangKey.ConfirmResetChanges);null===(e=this.__contextMenu)||void 0===e||e.close(),(this.__weeklySched.hasChanges()||this.__calendar.hasChanges())&&(yield t.Components.DialogWindow.confirm(s))&&(this.__weeklySched.resetChanges(),this.__calendar.resetChanges(),this.__updateResultSchedule(),null===(n=this.__saveButton)||void 0===n||n.setIsEnabled(!1),null===(a=this.__resetButton)||void 0===a||a.setIsEnabled(!1))})),this.__weeklySchedChangedHandler=()=>{this.__isAttached&&(this.__updateButtons(),this.__updateResultSchedule()),this.eventHandler.raise(s.ScheduleEvents.onChanged)},this.__calendarChangedHandler=()=>{this.__isAttached&&(this.__updateButtons(),this.__updateResultSchedule()),this.eventHandler.raise(s.ScheduleEvents.onChanged)}}__previnit(){super.__previnit(),this.baObjectHandler=new t.BaObjectHandler(this),this.__element.append(this.__contentWindow.getElement()),this.__resultSched=new t.Components.WeeklySchedule(this.__id+"-result-schedule",this),this.__resultSched.LoadEntriesFromBaObject=!1,this.__weeklySched=new t.Components.WeeklySchedule(this.__id+"-weekly-schedule",this),this.__calendar=new t.Components.Calendar(this.__id+"-calendar",this,{displayMode:t.Components.Calendar.CalendarDisplayMode.EventCalendar,visibilityMenu:!0}),this.__contextMenu.addRowEntry({controlsHorizontalAlignment:"Right",name:"first-row",controls:[{type:t.Components.ComponentType.Button,name:"save-button",callback:this.__saveButtonPressedHandler,settings:{isEnabled:!1,layout:{maxWidth:100}},cbOnCreated:e=>{this.__destroyersToCallOnDestroy.push(t.Locale.Localization.watchText(t.Locale.LangKey.Save,n=>{t.Logger.checkServerResult(t.Logger.Severity.warn,n)&&e.textHandler.setText(n.text)}))}},{type:t.Components.ComponentType.Button,callback:this.__resetButtonPressedHandler,name:"reset-button",settings:{isEnabled:!1,layout:{maxWidth:100}},cbOnCreated:e=>{this.__destroyersToCallOnDestroy.push(t.Locale.Localization.watchText(t.Locale.LangKey.Reset,n=>{t.Logger.checkServerResult(t.Logger.Severity.warn,n)&&e.textHandler.setText(n.text)}))}}]}),this.__saveButton=this.__contextMenu.getRowEntries()[0].controlContainer.getControl("save-button"),this.__resetButton=this.__contextMenu.getRowEntries()[0].controlContainer.getControl("reset-button"),this.__contentWindow.setContent(this.__tabWindow.getElement()),this.__resultSched.setReadOnly(!0);let e=this.__tabWindow.addTab(this.__tabWindow.getId()+"-result-schedule-tab");null!=e&&(e.setContent(this.__resultSched.getElement()),this.__destroyersToCallOnDestroy.push(t.Locale.Localization.watchText(t.Locale.LangKey.CurrentSched,n=>{t.Logger.checkServerResult(t.Logger.Severity.warn,n)&&(null==e||e.textHandler.setText(n.text))}))),this.__weeklySched.setReadOnly(!1);let n=this.__tabWindow.addTab(this.__tabWindow.getId()+"-weekly-schedule-tab");null!=n&&(n.setContent(this.__weeklySched.getElement()),this.__destroyersToCallOnDestroy.push(t.Locale.Localization.watchText(t.Locale.LangKey.WeeklySched,e=>{t.Logger.checkServerResult(t.Logger.Severity.warn,e)&&(null==n||n.textHandler.setText(e.text))})));let a=this.__tabWindow.addTab(this.__tabWindow.getId()+"-calendar-tab");null!=a&&(a.setContent(this.__calendar.getElement()),this.__destroyersToCallOnDestroy.push(t.Locale.Localization.watchText(t.Locale.LangKey.Calendar,e=>{t.Logger.checkServerResult(t.Logger.Severity.warn,e)&&(null==a||a.textHandler.setText(e.text))})))}__init(){super.__init()}__attach(){var e;super.__attach(),this.__tabWindow.selectTab(this.__tabWindow.getId()+"-result-schedule-tab"),this.__destroyersToCallOnDetach.push(this.__weeklySched.eventHandler.register(t.Components.WeeklySchedule.WeeklyScheduleEvents.onDataChanged,this.__weeklySchedChangedHandler)),this.__weeklySchedChangedHandler(),this.__destroyersToCallOnDetach.push(null===(e=this.__calendar)||void 0===e?void 0:e.eventHandler.register(t.Components.Calendar.CalendarEvent.onEventsChanged,()=>this.__calendarChangedHandler())),this.__calendarChangedHandler()}__detach(){super.__detach()}destroy(){this.__keepAlive||(this.__contentWindow.destroy(),this.__tabWindow.destroy(),this.__weeklySched.destroy(),this.__resultSched.destroy(),this.__calendar.destroy(),super.destroy())}__updateResultSchedule(){if(null==this.__calendar)return;let e=t.Helper.DateTime.getCurrentWeek("Monday");this.__resultSched.setStartDate(e.start);let n=JSON.parse(JSON.stringify(this.__weeklySched.getScheduleEntries()));if(!(n.length<=0)){for(let a=0;a<2;a++){let s=0==a?t.Components.Calendar.CalendarEventSource.BARef:t.Components.Calendar.CalendarEventSource.BA,i=JSON.parse(JSON.stringify(this.__calendar.getSchedExceptionEntries(s,e.start,e.end)));null!=i&&i.length>0&&this.__mergeWeeklyAndExceptions(e,n,i)}this.__resultSched.setScheduleEntries(n)}}__mergeWeeklyAndExceptions(e,n,a){let s=new Date;s.setHours(0,0,0,0);let i=s.getDate(),r=0;for(let o=0;o<a.length;o++){let l=a[o];switch(l.eType){case t.BA.DateValChoice.eWeekNDay:let h=l.uDate.stWeekNDay;if(h.eMonth===t.BA.Month.Unspecified||h.eMonth===s.getMonth()+1){if(h.eMonth!==t.BA.Month.Unspecified&&i<1+7*h.eMonth&&i>7+7*h.eMonth)continue;switch(h.eWeekday){case t.BA.Weekday.Unspecified:for(let e=0;e<n.length;e++)n[e]=this.__combineSchedEntries(n[e],a[o].aEntry);break;case t.BA.Weekday.Invalid:break;default:n[h.eWeekday-1]=this.__combineSchedEntries(n[h.eWeekday-1],a[o].aEntry)}}break;case t.BA.DateValChoice.eDateRange:let d=l.uDate.stDateRange,_=t.Helper.DateTime.convertBaDateToDate(d.stDateFrom),c=t.Helper.DateTime.convertBaDateToDate(d.stDateTo);if(_<e.start&&c<e.start||_>e.end&&c>e.end)continue;let u=e.start>_?e.start:_;for(;u<=c&&!(u>e.end);)r=u.getDay(),0===r&&(r=7),r--,n[r]=this.__combineSchedEntries(n[r],a[o].aEntry),u=new Date(u.getTime()+864e5);break;case t.BA.DateValChoice.eDate:if(255===l.uDate.stDate.nYear){let e=(new Date).getFullYear();l.uDate.stDate.nYear=e-t.BA.BaDate.YearOffset}if(l.uDate.stDate.nDay===t.BA.Day.Unspecified){if(l.uDate.stDate.eDayOfWeek===t.BA.Weekday.Unspecified)for(let e=0;e<n.length;e++)n[e]=this.__combineSchedEntries(n[e],a[o].aEntry);else n[l.uDate.stDate.eDayOfWeek-1]=this.__combineSchedEntries(n[l.uDate.stDate.eDayOfWeek-1],a[o].aEntry);break}{let s=t.Helper.DateTime.convertBaDateToDate(l.uDate.stDate);s>=e.start&&s<=e.end&&(r=s.getDay(),0===r&&(r=7),r--,n[r]=this.__combineSchedEntries(n[r],a[o].aEntry))}}}}__combineSchedEntries(e,n){if(!(e instanceof Array)||e.length<=0)return e;let a=[],s=[],i=!1;n.forEach(e=>{e.eState===t.BA.SchedEntryState.eValue?(s.push(e),i=!0):e.eState===t.BA.SchedEntryState.eNull&&!0===i&&(s.push(e),i=!1)});let r=[];e.forEach(e=>{e.eState===t.BA.SchedEntryState.eValue&&r.push(e)}),s=s.sort((e,n)=>t.Helper.DateTime.compareBaTime(e.stTime,n.stTime)),r=r.sort((e,n)=>t.Helper.DateTime.compareBaTime(e.stTime,n.stTime));let o=s.shift(),l=r.shift();for(;null!=l;)if(null==o||-1===t.Helper.DateTime.compareBaTime(l.stTime,o.stTime)){if(a.push(l),l=r.shift(),null==l&&null!=o)do{o.eState===t.BA.SchedEntryState.eValue&&a.push(o),o=s.shift()}while(null!=o)}else do{if(o.eState===t.BA.SchedEntryState.eValue)a.push(o);else if(null!=l){l.stTime=o.stTime,o=s.shift();break}if(null!=l&&-1===t.Helper.DateTime.compareBaTime(l.stTime,o.stTime)&&(l=r.shift()),o=s.shift(),null==o)return a}while(null!=o);return a}__updateButtons(){var e,t,n,a;this.__weeklySched.hasChanges()||this.__calendar.hasChanges()?(null===(e=this.__saveButton)||void 0===e||e.setIsEnabled(!0),null===(t=this.__resetButton)||void 0===t||t.setIsEnabled(!0)):(null===(n=this.__saveButton)||void 0===n||n.setIsEnabled(!1),null===(a=this.__resetButton)||void 0===a||a.setIsEnabled(!1))}processBaObject(){null!=this.baObjectHandler.baObject?(this.__weeklySched.baObjectHandler.setBaObject(this.baObjectHandler.baObject),this.__resultSched.baObjectHandler.setBaObject(this.baObjectHandler.baObject),this.__calendar.baObjectHandler.setBaObject(this.baObjectHandler.baObject),this.baObjectHandler.tryWatchBaVariable(t.BA.BaParameterId.eInstDescription,e=>{this.__contentWindow.setHeadlineText(e)})):this.__resultSched.setScheduleEntries(null)}getWeeklyScheudlerEntries(){return this.__weeklySched.getScheduleEntries()}writeScheduleToPlc(){return __awaiter(this,void 0,void 0,(function*(){return(1==this.__calendar.hasChanges()||1==this.__weeklySched.hasChanges())&&(1==this.__calendar.hasChanges()&&this.__calendar.writeToPlc(),1==this.__weeklySched.hasChanges()&&(yield this.__weeklySched.writeToPlc()),!0)}))}hasChanges(){return this.__weeklySched.hasChanges()||this.__calendar.hasChanges()}resetChanges(){this.__weeklySched.resetChanges(),this.__calendar.resetChanges()}setBaObject(e){return this.baObjectHandler.setBaObject(e),this}getBaObject(){return this.baObjectHandler.baObject}setOrientation(t){"string"==typeof t&&(t=Number(t));let n=e.ValueConverter.toNumber(t);return null==n&&(n=this.getAttributeDefaultValueInternal("Orientation")),n===this.__orientation||(this.__orientation=n,e.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"Orientation"}),this.__processOrientation()),this}__processOrientation(){this.__weeklySched.setOrientation(this.__orientation),this.__resultSched.setOrientation(this.__orientation)}getOrientation(){return this.__orientation}setShowHeader(t){let n=e.ValueConverter.toBoolean(t);return null==n&&(n=this.getAttributeDefaultValueInternal("ShowHeader")),n===this.__showHeader||(this.__showHeader=n,this.__processShowHeader(),e.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"ShowHeader"})),this}__processShowHeader(){this.__contentWindow.setShowHeader(this.__showHeader)}getShowHeader(){return this.__showHeader}setSnapPeriode(t){let n=e.ValueConverter.toNumber(t);return null==n&&(n=this.getAttributeDefaultValueInternal("SnapPeriode")),n===this.__snapPeriode||(this.__snapPeriode=n,this.__processSnapPeriode(),e.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"SnapPeriode"})),this}__processSnapPeriode(){this.__weeklySched.setSnapPeriode(this.__snapPeriode),this.__calendar.setSnapPeriode(this.__snapPeriode)}getSnapPeriode(){return this.__snapPeriode}setStateColors(n){let a=e.ValueConverter.toObject(n);if(null==a&&(a=this.getAttributeDefaultValueInternal("StateColors")),null!=a){let e=new Map;for(let n=0;n<a.length;n++){if(null==a[n].value||"number"!=typeof a[n].value||null==a[n].color||!t.Color.isSolidColor(a[n].color))return this;e.set(a[n].value,t.Color.RGBAColor.fromSolidColor(a[n].color))}}return this}getStateColors(){throw new Error("Attribute StateColors is not implemented yet!")}__processReadOnly(){super.__processReadOnly()}}a.Schedule=s,function(e){let t;!function(e){e.onChanged="onChanged",e.onSaved="onSaved"}(t=e.ScheduleEvents||(e.ScheduleEvents={}))}(s=a.Schedule||(a.Schedule={}))}(n.Management||(n.Management={}))}(t.Controls||(t.Controls={}))}(e.BuildingAutomation||(e.BuildingAutomation={}))}(TcHmi||(TcHmi={})),TcHmi.Controls.registerEx("Schedule","TcHmi.BuildingAutomation.Controls.Management",TcHmi.BuildingAutomation.Controls.Management.Schedule);